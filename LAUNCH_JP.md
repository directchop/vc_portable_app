# P2P ボイスチャットアプリケーション - 起動ガイド

## 概要
本アプリケーションは、TCP通信を使用した安定性重視のP2P（ピアツーピア）ボイスチャットアプリケーションです。CLI版とGUI版の両方をご利用いただけます。

## 主な特徴
- 🎯 TCPによる信頼性の高い音声通信
- 🔄 自動再接続機能で安定した通話を実現
- 🎮 シンプルなコマンドライン・インターフェース
- 🖥️ オプションのElectron GUIインターフェース
- 🔊 出力デバイス選択機能（スピーカー/ヘッドフォン切り替え）
- 💾 4KBチャンクバッファリングによる滑らかな音声再生
- 🌍 クロスプラットフォーム対応（macOS、Linux）

## システム要件

### 必須要件
- Node.js 14.0.0以上
- macOS: SoX（`brew install sox`でインストール）
- Linux: ALSAツール（通常プリインストール済み）

### 推奨環境
- メモリ: 2GB以上
- ネットワーク: 安定したインターネット接続
- マイク: 外部マイクまたは内蔵マイク

## インストール手順

### 1. 基本インストール
```bash
# リポジトリのクローン（既にある場合はスキップ）
cd /Users/hajime/Projects/nvoc_iso

# 依存関係のインストール
npm install
```

### 2. GUI版を使用する場合（オプション）
```bash
npm install --save-dev electron
```

## 起動方法

### CLI版の起動

#### 1. アプリケーションを起動
```bash
npm start
```

#### 2. 利用可能なコマンド
| コマンド | 説明 |
|---------|------|
| `server <ポート番号>` | サーバーとして起動し、接続を待機 |
| `connect <ホスト> <ポート>` | 指定したホストに接続 |
| `devices` | 利用可能な音声出力デバイスを表示 |
| `setoutput <デバイスID>` | 音声出力デバイスを変更 |
| `stop` | 現在の通話を終了 |
| `exit` | アプリケーションを終了 |

#### 3. 使用例

**ユーザーA（サーバー側）:**
```
server 8080
```

**ユーザーB（クライアント側）:**
```
connect 192.168.1.100 8080
```

### GUI版の起動

#### 1. GUIアプリケーションを起動
```bash
npm run start:gui
```

#### 2. GUI操作手順
1. **音声出力デバイスの選択**: 上部のドロップダウンメニューから選択
2. **モード選択**: 「Start as Server」または「Connect to Peer」をクリック
3. **接続設定**:
   - サーバーモード: ポート番号を入力して「Start Server」をクリック
   - クライアントモード: ホストとポート番号を入力して「Connect」をクリック
4. **通話終了**: 「Disconnect」ボタンをクリック

## 音声出力デバイスの設定

### CLI版での設定
```bash
# デバイス一覧を表示
devices

# 出力例:
# 1. Default System Output (ID: default)
# 2. AirPods Pro (ID: AirPods Pro)
# 3. External Headphones (ID: hw:1)

# デバイスを変更
setoutput AirPods Pro
```

### GUI版での設定
1. 画面上部のドロップダウンメニューから出力デバイスを選択
2. 更新ボタン（⟳）をクリックしてデバイスリストを更新
3. 変更は即座に反映されます

## トラブルシューティング

### よくある問題と解決方法

| 問題 | 解決方法 |
|------|---------|
| マイクへのアクセスが拒否される | システム設定でターミナル/アプリケーションにマイクアクセスを許可 |
| macOSでSoXが見つからない | `brew install sox`を実行 |
| 接続が拒否される | サーバーが起動していることを確認、ファイアウォール設定を確認 |
| Electronが起動しない | `npm install --save-dev electron`を実行 |
| 音声デバイスが動作しない | デバイスリストを更新するか、「default」デバイスを使用 |
| 音声が途切れる | ネットワーク接続を確認、バッファサイズの調整を検討 |

### ネットワーク設定

#### ポート開放が必要な場合
```bash
# macOS
sudo pfctl -e
echo "pass in proto tcp from any to any port 8080" | sudo pfctl -f -

# Linux (iptables)
sudo iptables -A INPUT -p tcp --dport 8080 -j ACCEPT
```

## セキュリティに関する注意事項

1. **プライベートネットワークでの使用を推奨**: 本アプリケーションは暗号化されていない通信を使用します
2. **信頼できる相手とのみ通話**: 接続先のIPアドレスを確認してください
3. **使用後はアプリケーションを終了**: 不要なポートを開放したままにしないでください

## パフォーマンス最適化

### 推奨設定
- **バッファサイズ**: 4KB（デフォルト）
- **サンプルレート**: 16kHz（音声通話に最適）
- **チャンネル数**: モノラル（帯域幅を節約）

### 音質を向上させるには
1. 有線ネットワーク接続を使用
2. 高品質な外部マイクを使用
3. 静かな環境で通話

## アンインストール方法

### GUI機能を削除する場合
以下のファイルを削除：
- `electron-main.js`
- `preload.js`
- `gui/` ディレクトリ
- `package.json`からelectronを削除

### 完全にアンインストールする場合
```bash
rm -rf /Users/hajime/Projects/nvoc_iso
```

## サポート情報

### 技術仕様
- **音声フォーマット**: 16-bit PCM, 16kHz, モノラル
- **バッファリング**: 4KBチャンク
- **再接続**: 指数バックオフによる自動リトライ
- **プロトコル**: TCP（信頼性重視）

### お問い合わせ
問題が発生した場合は、以下の情報と共にご報告ください：
- OS情報（macOS/Linuxのバージョン）
- Node.jsのバージョン（`node -v`）
- エラーメッセージの全文
- 問題が発生した際の操作手順

## リリースノート

### バージョン 1.0.0
- ✅ 基本的なP2P音声通話機能
- ✅ 自動再接続機能
- ✅ CLI版とGUI版の両方を提供
- ✅ 音声出力デバイス選択機能
- ✅ クロスプラットフォーム対応

---

🎉 **快適なボイスチャットをお楽しみください！**